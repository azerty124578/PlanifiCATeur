<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificateur de Cours et Agenda</title>
    <!-- On charge Tailwind CSS depuis un CDN pour un style rapide et r√©actif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Th√®me Rose (appliqu√© au body) */
        body.theme-pink {
            --bg-color: #fce7f3; /* pink-100 */
            --header-text: #9d174d; /* pink-800 */
            --secondary-text: #ec4899; /* pink-500 */
            --primary-btn-bg: #db2777; /* pink-600 */
            --primary-btn-hover: #be185d; /* pink-700 */
            --secondary-btn-bg: #fbcfe8; /* pink-200 */
            --secondary-btn-text: #be185d; /* pink-700 */
            --secondary-btn-hover: #f3e8ff; /* pink-100 */
            --list-item-bg: #fdf2f8; /* pink-50 */
            --input-border: #f9a8d4; /* pink-300 */
            --input-ring: #ec4899; /* pink-500 */
            --h2-color: #be185d; /* pink-700 */
            --comment-text: #db2777; /* pink-600 */
            --comment-bg: #fce7f3; /* pink-100 */
            --danger-color: #be185d; /* pink-700 pour le danger */
            --danger-hover: #9d174d; /* pink-800 */
        }

        /* Th√®me Bleu par d√©faut */
        body {
            --bg-color: #dbeafe; /* blue-100 */
            --header-text: #1e40af; /* blue-800 */
            --secondary-text: #3b82f6; /* blue-500 */
            --primary-btn-bg: #2563eb; /* blue-600 */
            --primary-btn-hover: #1d4ed8; /* blue-700 */
            --secondary-btn-bg: #bfdbfe; /* blue-200 */
            --secondary-btn-text: #1d4ed8; /* blue-700 */
            --secondary-btn-hover: #e0e7ff; /* blue-100 */
            --list-item-bg: #eff6ff; /* blue-50 */
            --input-border: #93c5fd; /* blue-300 */
            --input-ring: #3b82f6; /* blue-500 */
            --h2-color: #1d4ed8; /* blue-700 */
            --comment-text: #2563eb; /* blue-600 */
            --comment-bg: #dbeafe; /* blue-100 */
            --danger-color: #dc2626; /* red-600 pour le danger */
            --danger-hover: #b91c1c; /* red-700 */
        }

        /* Application des variables CSS */
        .app-bg { background-color: var(--bg-color); }
        .card { background-color: white; }
        .header-text { color: var(--header-text); }
        .secondary-text { color: var(--secondary-text); }
        .h2-color { color: var(--h2-color); }
        
        .btn-primary { 
            background-color: var(--primary-btn-bg);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover { background-color: var(--primary-btn-hover); }

        .btn-secondary {
            background-color: var(--secondary-btn-bg);
            color: var(--secondary-btn-text);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover { background-color: var(--secondary-btn-hover); }

        .btn-danger {
            background-color: var(--danger-color);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover { background-color: var(--danger-hover); }

        .list-item-bg { background-color: var(--list-item-bg); }
        
        .input-style {
            border-color: var(--input-border);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--input-ring);
            box-shadow: 0 0 0 3px rgba(var(--input-ring), 0.1);
        }

        .comment-bg { background-color: var(--comment-bg); }
        .comment-text { color: var(--comment-text); }
        .clear-modal-title-color { color: var(--danger-color); }
    </style>
</head>
<body class="app-bg min-h-screen transition-colors duration-300 flex items-center justify-center p-4">

    <!-- Modal pour les messages -->
    <div id="message-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full fade-in">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button id="modal-ok-btn" class="px-4 py-2 btn-primary text-white rounded-lg focus:outline-none transition-colors">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Modale de Confirmation pour Effacer Tout -->
    <div id="clear-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full fade-in">
            <h3 id="clear-modal-title" class="text-xl font-bold mb-4 clear-modal-title-color">Confirmer la suppression</h3>
            <p id="clear-modal-message" class="text-gray-600 mb-6">√ätes-vous s√ªr de vouloir effacer **toutes les donn√©es** ? Cette action est irr√©versible.</p>
            <div class="flex justify-end gap-3">
                <button id="clear-confirm-cancel-btn" class="px-4 py-2 btn-secondary text-sm rounded-lg focus:outline-none transition-colors">Annuler</button>
                <button id="clear-confirm-ok-btn" class="px-4 py-2 btn-danger text-white text-sm font-semibold rounded-lg focus:outline-none transition-colors">
                    Oui, tout effacer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour l'affichage des commentaires longs -->
    <div id="comment-display-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full fade-in">
            <h3 class="text-xl font-bold mb-4 header-text">Commentaire</h3>
            <div class="overflow-y-auto max-h-60 text-gray-600 mb-6 whitespace-pre-wrap break-words">
                <p id="comment-content"></p>
            </div>
            <div class="flex justify-end">
                <button id="comment-close-btn" class="px-4 py-2 btn-primary text-white rounded-lg focus:outline-none transition-colors">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Conteneur principal de l'application -->
    <div class="card p-6 sm:p-8 w-full max-w-lg container">
        <header class="mb-6 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2 header-text">PlanifiCATeur de Cours</h1>
            <h1 class="text-3xl sm:text-4xl font-bold mb-2 header-text">‡¥¶‡µç‡¥¶‡¥øÔºà‚Ä¢ Àï ‚Ä¢„Éû.·êü</h1>
            <p class="text-sm secondary-text">
                Salem le rho bon courage pour le taff bg !
            </p>
        </header>

        <!-- Section du planificateur de r√©p√©tition (visible par d√©faut) -->
        <main id="repetition-view" class="space-y-6">
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 h2-color">Ajouter un cours</h2>
                <div class="flex flex-col gap-4">
                    <input type="text" id="course-input" placeholder="Nom du cours..."
                           class="flex-grow p-3 rounded-lg border input-style">
                    <textarea id="course-comment" placeholder="Commentaire sur le cours..."
                              class="flex-grow p-3 rounded-lg border input-style resize-none"></textarea>
                    <button id="add-course-btn"
                            class="w-full px-6 py-3 btn-primary text-white font-semibold rounded-lg shadow-md active:scale-95 transition-all duration-200 ease-in-out">
                        Ajouter le cours ‚ûï
                    </button>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-semibold mb-4 h2-color">√Ä r√©viser aujourd'hui ‚≠ê</h2>
                <div id="today-list" class="space-y-3"></div>
                <p id="no-today-courses" class="text-gray-500 text-center mt-4 hidden">Aucun cours √† r√©viser aujourd'hui ! Profitez-en bien ! üéâ</p>
            </div>

            <div>
                <h2 class="text-2xl font-semibold mb-4 h2-color">√Ä venir ‚è≥</h2>
                <div id="upcoming-list" class="space-y-3"></div>
                <p id="no-upcoming-courses" class="text-gray-500 text-center mt-4 hidden">Miaou ! Ajoutez vos premiers cours pour commencer.</p>
            </div>
            
            <div class="mt-8 text-center">
                <button id="clear-all-repetition-btn" class="px-3 py-1 btn-danger text-white text-xs font-semibold rounded-lg shadow-md hover:scale-105 active:scale-95 transition-all duration-200 ease-in-out">
                    Tout effacer üßπ
                </button>
            </div>
        </main>

        <!-- Section de l'agenda (cach√©e par d√©faut) -->
        <section id="agenda-view" class="space-y-6 hidden">
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 h2-color">Ajouter une t√¢che</h2>
                <div class="flex flex-col gap-4">
                    <input type="text" id="task-title" placeholder="Titre de la t√¢che..."
                           class="flex-grow p-3 rounded-lg border input-style">
                    <input type="date" id="task-date"
                           class="flex-grow p-3 rounded-lg border input-style">
                    <input type="number" id="task-days-to-do" min="1" step="1" placeholder="Temps estim√© (en jours)"
                           class="flex-grow p-3 rounded-lg border input-style">
                    <textarea id="task-comment" placeholder="Commentaire sur la t√¢che..."
                              class="flex-grow p-3 rounded-lg border input-style resize-none"></textarea>
                    <button id="add-task-btn"
                            class="w-full px-6 py-3 btn-primary text-white font-semibold rounded-lg shadow-md active:scale-95 transition-all duration-200 ease-in-out">
                        Ajouter la t√¢che ‚úÖ
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-2">
                <button id="show-pending-btn" class="px-3 py-1 btn-secondary text-xs font-semibold rounded-lg transition-colors">
                    Voir les t√¢ches en attente
                </button>
            </div>

            <div>
                <h2 class="text-2xl font-semibold mb-4 h2-color">T√¢ches √† faire</h2>
                <div id="to-do-list" class="space-y-3"></div>
                <p id="no-to-do-tasks" class="text-gray-500 text-center mt-4 hidden">Rien √† faire pour le moment. üéâ</p>
            </div>
            
            <div id="pending-tasks-section" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 h2-color">T√¢ches en attente</h2>
                <div id="pending-list" class="space-y-3"></div>
                <p id="no-pending-tasks" class="text-gray-500 text-center mt-4 hidden">Aucune t√¢che en attente.</p>
            </div>

            <div class="mt-8 text-center">
                <button id="clear-all-agenda-btn" class="px-3 py-1 btn-danger text-white text-xs font-semibold rounded-lg shadow-md hover:scale-105 active:scale-95 transition-all duration-200 ease-in-out">
                    Tout effacer üßπ
                </button>
            </div>
        </section>

        <!-- Barre de boutons d'action en bas de la page -->
        <div class="mt-8 flex justify-end gap-4 flex-wrap w-full">
            <button id="btn-return" class="hidden px-4 py-2 btn-secondary text-sm font-semibold rounded-lg transition-colors">
                Retour
            </button>
            <button id="export-btn" class="px-3 py-1 btn-secondary text-xs font-semibold rounded-lg shadow-md active:scale-95 transition-all duration-200 ease-in-out">
                Exporter üíæ
            </button>
            <input type="file" id="import-file" class="hidden" accept=".json">
            <button id="import-btn" class="px-3 py-1 btn-secondary text-xs font-semibold rounded-lg shadow-md active:scale-95 transition-all duration-200 ease-in-out">
                Importer üì•
            </button>
            <button id="btn-agenda" class="px-4 py-2 btn-primary text-white text-sm font-semibold rounded-lg active:scale-95 transition-all duration-200 ease-in-out">
                Agenda üóìÔ∏è
            </button>
            <button id="toggle-theme-btn" class="px-3 py-1 btn-secondary text-xs font-semibold rounded-lg shadow-md active:scale-95 transition-all duration-200 ease-in-out">
                Basculer le th√®me üé®
            </button>
        </div>
    </div>
    
    <script>
        // Cl√© de stockage unifi√©e pour toutes les donn√©es
        const STORAGE_KEY = 'unified_app_data';
        const THEME_KEY = 'app_theme';

        // Constantes pour le planificateur de r√©p√©tition
        const REPETITION_INTERVALS = [1, 3, 7, 14, 30, 60, 90]; 

        // R√©cup√©ration des √©l√©ments du DOM
        const body = document.body;
        const btnRepetition = document.getElementById('btn-return');
        const btnAgenda = document.getElementById('btn-agenda');
        const repetitionView = document.getElementById('repetition-view');
        const agendaView = document.getElementById('agenda-view');
        
        const courseInput = document.getElementById('course-input');
        const courseCommentInput = document.getElementById('course-comment');
        const addCourseBtn = document.getElementById('add-course-btn');
        const todayList = document.getElementById('today-list');
        const upcomingList = document.getElementById('upcoming-list');
        const noTodayCourses = document.getElementById('no-today-courses');
        const noUpcomingCourses = document.getElementById('no-upcoming-courses');
        const clearAllRepetitionBtn = document.getElementById('clear-all-repetition-btn');

        const taskTitleInput = document.getElementById('task-title');
        const taskDateInput = document.getElementById('task-date');
        const taskDaysToDoInput = document.getElementById('task-days-to-do');
        const taskCommentInput = document.getElementById('task-comment');
        const addTaskBtn = document.getElementById('add-task-btn');
        const toDoList = document.getElementById('to-do-list');
        const pendingList = document.getElementById('pending-list');
        const showPendingBtn = document.getElementById('show-pending-btn');
        const pendingTasksSection = document.getElementById('pending-tasks-section');
        const noToDoTasks = document.getElementById('no-to-do-tasks');
        const noPendingTasks = document.getElementById('no-pending-tasks');
        const clearAllAgendaBtn = document.getElementById('clear-all-agenda-btn');

        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFile = document.getElementById('import-file');
        const toggleThemeBtn = document.getElementById('toggle-theme-btn');
        
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        const clearConfirmModal = document.getElementById('clear-confirm-modal');
        const clearModalMessage = document.getElementById('clear-modal-message');
        const clearConfirmOkBtn = document.getElementById('clear-confirm-ok-btn');
        const clearConfirmCancelBtn = document.getElementById('clear-confirm-cancel-btn');

        const commentDisplayModal = document.getElementById('comment-display-modal');
        const commentContent = document.getElementById('comment-content');
        const commentCloseBtn = document.getElementById('comment-close-btn');

        // Mod√®le de donn√©es unifi√©es
        let unifiedData = {
            courses: [],
            tasks: []
        };
        
        let showAllPending = false;
        let pendingClearAction = null;

        // Fonctions utilitaires
        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        modalOkBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        function showCommentModal(comment) {
            commentContent.textContent = comment || "Aucun commentaire";
            commentDisplayModal.classList.remove('hidden');
        }

        commentCloseBtn.addEventListener('click', () => {
            commentDisplayModal.classList.add('hidden');
        });

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(unifiedData));
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Conversion des dates en objets Date
                    if (parsedData.courses) {
                        parsedData.courses = parsedData.courses.map(course => ({
                            ...course,
                            nextReviewDate: new Date(course.nextReviewDate)
                        }));
                    }
                    if (parsedData.tasks) {
                        parsedData.tasks = parsedData.tasks.map(task => ({
                            ...task,
                            dueDate: new Date(task.dueDate),
                            date: new Date(task.date || task.dueDate)
                        }));
                    }
                    unifiedData = parsedData;
                }
            } catch (e) {
                console.error("Erreur de chargement des donn√©es :", e);
                showMessage("Erreur", "Impossible de charger les donn√©es. Un nouveau fichier a √©t√© cr√©√©.");
            }
        }

        // Fonctions pour le planificateur de r√©p√©tition
        function renderCourses() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            todayList.innerHTML = '';
            upcomingList.innerHTML = '';

            const todayCourses = unifiedData.courses.filter(course => course.nextReviewDate <= today);
            const upcomingCourses = unifiedData.courses.filter(course => course.nextReviewDate > today).sort((a, b) => a.nextReviewDate - b.nextReviewDate);

            noTodayCourses.classList.toggle('hidden', todayCourses.length > 0);
            noUpcomingCourses.classList.toggle('hidden', unifiedData.courses.length > 0);

            todayCourses.forEach(course => {
                todayList.appendChild(createCourseListItem(course, true));
            });

            upcomingCourses.forEach(course => {
                upcomingList.appendChild(createCourseListItem(course, false));
            });
        }

        function createCourseListItem(course, isToday) {
            const li = document.createElement('div');
            li.className = `p-4 rounded-lg shadow-sm list-item-bg transition-all duration-300 hover:scale-102`;

            const dateStr = course.nextReviewDate.toLocaleDateString('fr-FR');
            const intervalText = course.currentInterval === 1 ? '1 jour' : `${course.currentInterval} jours`;
            const hasComment = course.comment && course.comment.trim().length > 0;
            const commentPreview = hasComment ? course.comment.substring(0, 50) + (course.comment.length > 50 ? '...' : '') : '';

            li.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">${escapeHtml(course.name)}</h3>
                        <p class="text-sm text-gray-600 mb-2">
                            ${isToday ? '√Ä r√©viser aujourd\'hui' : `Prochaine r√©vision : ${dateStr}`} ‚Ä¢ 
                            Intervalle : ${intervalText} ‚Ä¢ Niveau : ${course.level}
                        </p>
                        ${hasComment ? `<p class="text-xs comment-text">üí¨ ${escapeHtml(commentPreview)}</p>` : ''}
                    </div>
                    <div class="flex gap-2 shrink-0">
                        ${hasComment ? `
                            <button class="p-2 rounded-lg transition-colors hover:scale-110 active:scale-95 duration-200 ease-in-out hover:bg-gray-200" onclick="showCommentModal('${escapeHtml(course.comment)}')">
                                <span class="text-xl">üëÅÔ∏è</span>
                            </button>
                        ` : ''}
                        <button class="p-2 rounded-lg transition-colors hover:scale-110 active:scale-95 duration-200 ease-in-out hover:bg-gray-200" onclick="editCommentCourse('${escapeHtml(course.name)}')">
                            <span class="text-xl">üìù</span>
                        </button>
                        ${isToday ? `
                            <button class="px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-500 hover:scale-105 active:scale-95 transition-all duration-200 ease-in-out shrink-0" onclick="markCourseAsReviewed('${escapeHtml(course.name)}', true)">
                                ‚úÖ R√©ussi
                            </button>
                            <button class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-600 hover:scale-105 active:scale-95 transition-all duration-200 ease-in-out shrink-0" onclick="markCourseAsReviewed('${escapeHtml(course.name)}', false)">
                                ‚ùå √âchou√©
                            </button>
                        ` : ''}
                        <button class="p-2 rounded-lg transition-colors hover:scale-110 active:scale-95 duration-200 ease-in-out hover:bg-gray-200" onclick="deleteCourse('${escapeHtml(course.name)}')">
                            <span class="text-xl">üóëÔ∏è</span>
                        </button>
                    </div>
                </div>
                <div id="comment-editor-course-${escapeHtml(course.name)}" class="w-full mt-4 p-4 rounded-lg hidden comment-bg">
                    <textarea class="w-full h-24 p-2 rounded-lg border border-gray-300 resize-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-300" placeholder="√âcrivez votre commentaire ici...">${escapeHtml(course.comment || '')}</textarea>
                    <div class="flex justify-end mt-2">
                        <button class="px-4 py-2 text-white text-sm font-semibold rounded-lg btn-primary active:scale-95 transition-all duration-200 ease-in-out" onclick="saveCommentCourse('${escapeHtml(course.name)}')">Sauvegarder</button>
                    </div>
                </div>
            `;

            return li;
        }

        window.editCommentCourse = function(courseName) {
            const editor = document.getElementById(`comment-editor-course-${courseName}`);
            const course = unifiedData.courses.find(c => c.name === courseName);
            if (course) {
                editor.querySelector('textarea').value = course.comment || '';
            }
            editor.classList.toggle('hidden');
        }

        window.saveCommentCourse = function(courseName) {
            const editor = document.getElementById(`comment-editor-course-${courseName}`);
            const textarea = editor.querySelector('textarea');
            const newComment = textarea.value.trim();
            unifiedData.courses = unifiedData.courses.map(course => {
                if (course.name === courseName) {
                    return { ...course, comment: newComment };
                }
                return course;
            });
            saveData();
            editor.classList.add('hidden');
            renderCourses();
        }

        window.markCourseAsReviewed = function(courseName, success) {
            const course = unifiedData.courses.find(c => c.name === courseName);
            if (course) {
                if (success) {
                    course.level++;
                    if (course.level >= REPETITION_INTERVALS.length) {
                        course.level = REPETITION_INTERVALS.length - 1;
                    }
                    course.currentInterval = REPETITION_INTERVALS[course.level];
                } else {
                    course.level = Math.max(0, course.level - 1);
                    course.currentInterval = REPETITION_INTERVALS[course.level];
                }
                course.nextReviewDate = addDays(new Date(), course.currentInterval);
                saveData();
                renderCourses();
            }
        }

        window.deleteCourse = function(courseName) {
            unifiedData.courses = unifiedData.courses.filter(c => c.name !== courseName);
            saveData();
            renderCourses();
        }

        addCourseBtn.addEventListener('click', () => {
            const courseName = courseInput.value.trim();
            const courseComment = courseCommentInput.value.trim();
            
            if (courseName) {
                if (unifiedData.courses.find(c => c.name === courseName)) {
                    showMessage("Cours d√©j√† existant", "Ce cours existe d√©j√† dans votre planificateur.");
                    return;
                }

                const newCourse = {
                    name: courseName,
                    level: 0,
                    currentInterval: REPETITION_INTERVALS[0],
                    nextReviewDate: new Date(),
                    comment: courseComment
                };

                unifiedData.courses.push(newCourse);
                courseInput.value = '';
                courseCommentInput.value = '';
                saveData();
                renderCourses();
            }
        });

        courseInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addCourseBtn.click();
            }
        });

        // Gestionnaire pour effacer tous les cours
        clearAllRepetitionBtn.addEventListener('click', () => {
            if (unifiedData.courses.length === 0) {
                showMessage("Rien √† effacer", "Il n'y a pas de cours dans votre planificateur √† supprimer.");
                return;
            }

            clearModalMessage.innerHTML = "√ätes-vous certain de vouloir effacer **tous les cours** de votre planificateur ? Cette action est irr√©versible.";
            clearConfirmModal.classList.remove('hidden');
            pendingClearAction = () => {
                unifiedData.courses = [];
                saveData();
                renderCourses();
                showMessage("Succ√®s", "Tous les cours ont √©t√© effac√©s.");
            };
        });

        // Fonctions pour l'agenda
        function renderTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const oneDay = 24 * 60 * 60 * 1000;

            toDoList.innerHTML = '';
            pendingList.innerHTML = '';

            const tasksSorted = unifiedData.tasks.sort((a, b) => a.dueDate - b.dueDate);

            const toDoTasks = tasksSorted.filter(task => {
                const daysLeft = Math.ceil((task.dueDate.getTime() - today.getTime()) / oneDay);
                return daysLeft <= task.daysToDo;
            });
            
            const pendingTasks = tasksSorted.filter(task => {
                const daysLeft = Math.ceil((task.dueDate.getTime() - today.getTime()) / oneDay);
                return daysLeft > task.daysToDo;
            });

            // Affichage des t√¢ches √† faire
            noToDoTasks.classList.toggle('hidden', toDoTasks.length > 0);
            toDoTasks.forEach(task => {
                toDoList.appendChild(createTaskListItem(task));
            });

            // Gestion de l'affichage des t√¢ches en attente
            if (showAllPending) {
                pendingTasksSection.classList.remove('hidden');
                showPendingBtn.textContent = 'Masquer les t√¢ches en attente';
                noPendingTasks.classList.toggle('hidden', pendingTasks.length > 0);
                pendingTasks.forEach(task => {
                    pendingList.appendChild(createTaskListItem(task));
                });
            } else {
                pendingTasksSection.classList.add('hidden');
                showPendingBtn.textContent = 'Voir les t√¢ches en attente';
            }

            showPendingBtn.style.display = pendingTasks.length > 0 ? 'inline-block' : 'none';
        }

        function createTaskListItem(task) {
            const li = document.createElement('div');
            li.className = `p-4 rounded-lg shadow-sm list-item-bg transition-all duration-300 hover:scale-102`;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const oneDay = 24 * 60 * 60 * 1000;
            const daysLeft = Math.ceil((task.dueDate.getTime() - today.getTime()) / oneDay);

            let urgencyClass = '';
            let urgencyText = '';

            if (daysLeft < 0) {
                urgencyClass = 'text-red-600 font-semibold';
                urgencyText = `En retard de ${Math.abs(daysLeft)} jour(s)`;
            } else if (daysLeft === 0) {
                urgencyClass = 'text-red-600 font-semibold';
                urgencyText = '√Ä faire aujourd\'hui !';
            } else if (daysLeft <= 3) {
                urgencyClass = 'text-orange-600 font-medium';
                urgencyText = `Dans ${daysLeft} jour(s)`;
            } else {
                urgencyClass = 'text-gray-600';
                urgencyText = `Dans ${daysLeft} jour(s)`;
            }

            const hasComment = task.comment && task.comment.trim().length > 0;
            const commentDisplay = hasComment ? `üí¨ ${task.comment.substring(0, 50)}${task.comment.length > 50 ? '...' : ''}` : '';

            li.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">${escapeHtml(task.title)}</h3>
                        <p class="text-sm ${urgencyClass} mb-1">${urgencyText}</p>
                        <p class="text-sm text-gray-600 mb-1">Date limite : ${task.dueDate.toLocaleDateString('fr-FR')}</p>
                        <p class="text-sm text-gray-600 mb-1">Temps estim√© : ${task.daysToDo} jour(s)</p>
                        ${hasComment ? `<p class="text-xs comment-text">${commentDisplay}</p>` : ''}
                    </div>
                    <div class="flex gap-2 shrink-0">
                        ${hasComment ? `
                            <button class="p-2 rounded-lg transition-colors hover:scale-110 active:scale-95 duration-200 ease-in-out hover:bg-gray-200" onclick="showCommentModal('${escapeHtml(task.comment)}')">
                                <span class="text-xl">üëÅÔ∏è</span>
                            </button>
                        ` : ''}
                        <button class="p-2 rounded-lg transition-colors hover:scale-110 active:scale-95 duration-200 ease-in-out hover:bg-gray-200" onclick="editCommentTask('${escapeHtml(task.title)}')">
                            <span class="text-xl">üìù</span>
                        </button>
                        <button class="p-2 rounded-lg transition-colors hover:scale-110 active:scale-95 duration-200 ease-in-out hover:bg-gray-200" onclick="deleteTask('${escapeHtml(task.title)}')">
                            <span class="text-xl">üóëÔ∏è</span>
                        </button>
                    </div>
                </div>
                <div id="comment-editor-task-${escapeHtml(task.title)}" class="w-full mt-4 p-4 rounded-lg hidden comment-bg">
                    <textarea class="w-full h-24 p-2 rounded-lg border border-gray-300 resize-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-300" placeholder="√âcrivez votre commentaire ici...">${escapeHtml(task.comment || '')}</textarea>
                    <div class="flex justify-end mt-2">
                        <button class="px-4 py-2 text-white text-sm font-semibold rounded-lg btn-primary active:scale-95 transition-all duration-200 ease-in-out" onclick="saveCommentTask('${escapeHtml(task.title)}')">Sauvegarder</button>
                    </div>
                </div>
            `;

            return li;
        }

        window.editCommentTask = function(taskTitle) {
            const editor = document.getElementById(`comment-editor-task-${taskTitle}`);
            const task = unifiedData.tasks.find(t => t.title === taskTitle);
            if (task) {
                editor.querySelector('textarea').value = task.comment || '';
            }
            editor.classList.toggle('hidden');
        }

        window.saveCommentTask = function(taskTitle) {
            const editor = document.getElementById(`comment-editor-task-${taskTitle}`);
            const textarea = editor.querySelector('textarea');
            const newComment = textarea.value.trim();
            unifiedData.tasks = unifiedData.tasks.map(task => {
                if (task.title === taskTitle) {
                    return { ...task, comment: newComment };
                }
                return task;
            });
            saveData();
            editor.classList.add('hidden');
            renderTasks();
        }

        window.deleteTask = function(taskTitle) {
            unifiedData.tasks = unifiedData.tasks.filter(t => t.title !== taskTitle);
            saveData();
            renderTasks();
        }

        // Validation pour les nombres entiers dans le champ temps estim√©
        taskDaysToDoInput.addEventListener('input', (e) => {
            const value = e.target.value;
            if (value.includes('.') || value.includes(',')) {
                e.target.value = Math.floor(parseFloat(value)) || '';
            }
        });

        addTaskBtn.addEventListener('click', () => {
            const title = taskTitleInput.value.trim();
            const date = taskDateInput.value;
            const daysToDo = parseInt(taskDaysToDoInput.value, 10);
            
            if (!title || !date || isNaN(daysToDo) || daysToDo <= 0) {
                showMessage("Erreur", "Le titre, la date et le temps estim√© (doit √™tre un nombre positif) sont requis !");
                return;
            }
            if (unifiedData.tasks.some(t => t.title === title)) {
                showMessage("Erreur", "Cette t√¢che existe d√©j√†.");
                return;
            }
            
            unifiedData.tasks.push({
                title: title,
                dueDate: new Date(date),
                date: new Date(date),
                daysToDo: daysToDo,
                comment: taskCommentInput.value.trim()
            });
            saveData();
            taskTitleInput.value = '';
            taskDateInput.value = '';
            taskDaysToDoInput.value = '';
            taskCommentInput.value = '';
            renderTasks();
        });

        showPendingBtn.addEventListener('click', () => {
            showAllPending = !showAllPending;
            renderTasks();
        });

        clearAllAgendaBtn.addEventListener('click', () => {
            if (unifiedData.tasks.length === 0) {
                showMessage("Rien √† effacer", "Il n'y a pas de t√¢ches dans votre agenda √† supprimer.");
                return;
            }

            clearModalMessage.innerHTML = "√ätes-vous certain de vouloir effacer **toutes les t√¢ches** de votre agenda ? Cette action est irr√©versible.";
            clearConfirmModal.classList.remove('hidden');
            pendingClearAction = () => {
                unifiedData.tasks = [];
                saveData();
                renderTasks();
                showMessage("Succ√®s", "Toutes les t√¢ches ont √©t√© effac√©es.");
            };
        });

        // Gestion de la modale de confirmation
        clearConfirmOkBtn.addEventListener('click', () => {
            if (pendingClearAction) {
                pendingClearAction();
                pendingClearAction = null;
            }
            clearConfirmModal.classList.add('hidden');
        });

        clearConfirmCancelBtn.addEventListener('click', () => {
            clearConfirmModal.classList.add('hidden');
            pendingClearAction = null;
        });

        // Gestion de la navigation
        btnAgenda.addEventListener('click', () => {
            repetitionView.classList.add('hidden');
            agendaView.classList.remove('hidden');
            btnAgenda.classList.add('hidden');
            btnRepetition.classList.remove('hidden');
            renderTasks();
        });

        btnRepetition.addEventListener('click', () => {
            agendaView.classList.add('hidden');
            repetitionView.classList.remove('hidden');
            btnRepetition.classList.add('hidden');
            btnAgenda.classList.remove('hidden');
            renderCourses();
        });

        // Exportation
        exportBtn.addEventListener('click', () => {
            const dataStr = JSON.stringify(unifiedData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `planificateur_agenda_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        });

        // Importation
        importBtn.addEventListener('click', () => {
            importFile.click();
        });

        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (importedData && Array.isArray(importedData.courses) && Array.isArray(importedData.tasks)) {
                        unifiedData = importedData;
                        saveData();
                        loadData();
                        renderCourses();
                        renderTasks();
                        showMessage("Importation r√©ussie", "Les donn√©es ont √©t√© import√©es avec succ√®s.");
                    } else {
                        throw new Error("Structure de fichier invalide.");
                    }
                } catch (error) {
                    console.error("Erreur d'importation :", error);
                    showMessage("Erreur d'importation", "Le fichier s√©lectionn√© est invalide ou corrompu.");
                }
            };
            reader.readAsText(file);
            e.target.value = null;
        });

        // Gestion du th√®me
        toggleThemeBtn.addEventListener('click', () => {
            if (body.classList.contains('theme-pink')) {
                body.classList.remove('theme-pink');
                localStorage.setItem(THEME_KEY, 'blue');
            } else {
                body.classList.add('theme-pink');
                localStorage.setItem(THEME_KEY, 'pink');
            }
            
            if (!repetitionView.classList.contains('hidden')) {
                renderCourses();
            }
            if (!agendaView.classList.contains('hidden')) {
                renderTasks();
            }
        });

        // Initialisation au chargement de la page
        window.addEventListener('load', () => {
            loadData();
            
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'blue') {
                body.classList.remove('theme-pink');
            } else {
                body.classList.add('theme-pink');
            }

            renderCourses();
        });
    </script>
</body>
</html>


